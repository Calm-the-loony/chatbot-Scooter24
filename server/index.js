const express = require("express");
const cors = require("cors");
const app = express();

app.use(cors());
app.use(express.json());

// ะัั ะดะปั ััะฐะฝะตะฝะธั ะบะพะฝัะตะบััะฐ ะดะธะฐะปะพะณะฐ
const dialogContext = new Map();

app.post("/api/chat", (req, res) => {
  const userId = req.ip; // ะัะฟะพะปัะทัะตะผ IP ะบะฐะบ ะธะดะตะฝัะธัะธะบะฐัะพั ะฟะพะปัะทะพะฒะฐัะตะปั
  const userMessage = req.body.message.toLowerCase();

  // ะะพะปััะฐะตะผ ะธะปะธ ะธะฝะธัะธะฐะปะธะทะธััะตะผ ะบะพะฝัะตะบัั ะดะธะฐะปะพะณะฐ
  if (!dialogContext.has(userId)) {
    dialogContext.set(userId, {
      lastQuestions: [],
      context: {}
    });
  }

  const userContext = dialogContext.get(userId);
  const reply = getBotReply(userMessage, userContext);
  
  // ะะฑะฝะพะฒะปัะตะผ ะบะพะฝัะตะบัั
  userContext.lastQuestions.unshift(userMessage);
  if (userContext.lastQuestions.length > 3) {
    userContext.lastQuestions.pop();
  }

  // ะะพะฑะฐะฒะปัะตะผ ะฑัััััะต ะพัะฒะตัั, ะตัะปะธ ััะพ ัะผะตััะฝะพ
  let quickReplies = null;
  if (/ะทะฐะบะฐะท|ะพะฟะปะฐั|ะดะพััะฐะฒะบ/i.test(userMessage)) {
    quickReplies = ["ะกัะฐััั ะทะฐะบะฐะทะฐ", "ะกะฟะพัะพะฑั ะพะฟะปะฐัั", "ะกัะพะบะธ ะดะพััะฐะฒะบะธ"];
  } else if (/ะบะพะฝัะฐะบั|ัะฒัะทะฐัััั/i.test(userMessage)) {
    quickReplies = ["ะขะตะปะตัะพะฝ", "WhatsApp", "Email"];
  }

  res.json({ 
    reply,
    quickReplies 
  });
});

function getBotReply(message, context) {
  // ะัะพะฒะตััะตะผ, ัะฒะปัะตััั ะปะธ ัะพะพะฑัะตะฝะธะต ะฟัะพะดะพะปะถะตะฝะธะตะผ ะฟัะตะดัะดััะตะณะพ ะฒะพะฟัะพัะฐ
  const lastQuestion = context.lastQuestions[0] || '';
  
  if (/ะดะพััะฐะฒะบ[ะฐะธั]|ัะบะพะปัะบะพ.*ะดะปะธััั|ะฒัะตะผั.*ะดะพััะฐะฒะบ|ะบะพะณะดะฐ.*ะฟะพะปััั/i.test(message)) {
    return "ะะพััะฐะฒะบะฐ ะพัััะตััะฒะปัะตััั ะฒ ัะตัะตะฝะธะต 3-5 ัะฐะฑะพัะธั ะดะฝะตะน ะฟะพ ะฒัะตะน ะะพััะธะธ. ะญะบัะฟัะตัั-ะดะพััะฐะฒะบะฐ ะดะพัััะฟะฝะฐ ะทะฐ ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะฟะปะฐัั.";
  }

  if (/ะพะฟะปะฐั[ะฐัั]|ัะฟะพัะพะฑ.*ะพะฟะปะฐั|ะบะฐััะพะน|ะฝะฐะปะธัะฝัะผะธ|ััะตั/i.test(message)) {
    return "ะั ะฟัะธะฝะธะผะฐะตะผ ะพะฟะปะฐัั: ะบะฐััะพะน ะฝะฐ ัะฐะนัะต, ะฟะพ ััะตัั ะดะปั ััะธะดะธัะตัะบะธั ะปะธั, ะฝะฐะปะธัะฝัะผะธ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะธ ัะตัะตะท ัะธััะตะผั ัะปะตะบััะพะฝะฝัั ะฟะปะฐัะตะถะตะน.";
  }

  if (/ะณะฐัะฐะฝัะธ[ัะธั]|ะณะฐัะฐะฝัะธะนะฝ|ัะตะผะพะฝั ะฟะพ ะณะฐัะฐะฝัะธะธ/i.test(message)) {
    return "ะะฐัะฐะฝัะธั ะฝะฐ ะฒัะต ะทะฐะฟัะฐััะธ โ 6 ะผะตัััะตะฒ. ะะปั ะฐะบัะธะฒะฐัะธะธ ะณะฐัะฐะฝัะธะธ ัะพััะฐะฝัะนัะต ัะตะบ ะธ ัะฟะฐะบะพะฒะบั.";
  }

  if (/ะฒะพะทะฒัะฐั|ะฒะตัะฝััั.*ัะพะฒะฐั|ััะปะพะฒะธั.*ะฒะพะทะฒัะฐั|ะพะฑะผะตะฝ/i.test(message)) {
    return "ะั ะผะพะถะตัะต ะฒะตัะฝััั ัะพะฒะฐั ะฒ ัะตัะตะฝะธะต 14 ะดะฝะตะน ะฟัะธ ัะพััะฐะฝะตะฝะธะธ ัะฟะฐะบะพะฒะบะธ ะธ ัะพะฒะฐัะฝะพะณะพ ะฒะธะดะฐ. ะะพะทะฒัะฐั ะฒะพะทะผะพะถะตะฝ ะฒ ะฝะฐัะตะผ ะผะฐะณะฐะทะธะฝะต ะธะปะธ ัะตัะตะท ะผะฐัะบะตัะฟะปะตะนั.";
  }

  if (/ะทะฐะบะฐะท|ะพัะพัะผะธัั.*ะทะฐะบะฐะท|ะบะฐะบ.*ะบัะฟะธัั|ะฟะพะบัะฟะบ/i.test(message)) {
    return "ะงัะพะฑั ะพัะพัะผะธัั ะทะฐะบะฐะท:\n1. ะัะฑะตัะธัะต ัะพะฒะฐั\n2. ะะพะฑะฐะฒััะต ะฒ ะบะพัะทะธะฝั\n3. ะะตัะตะนะดะธัะต ะฒ ะพัะพัะผะปะตะฝะธะต ะทะฐะบะฐะทะฐ\n4. ะฃะบะฐะถะธัะต ะดะฐะฝะฝัะต ะดะปั ะดะพััะฐะฒะบะธ\n5. ะะฟะปะฐัะธัะต ะทะฐะบะฐะท";
  }

  if (/ะทะฐะฟัะฐัั|ะฟะพะดะฑะพั|ัะพะฒะผะตััะธะผ|ะดะธะฐะผะตัั|ัะฐะทะผะตั/i.test(message)) {
    return "ะะปั ะฟะพะดะฑะพัะฐ ะทะฐะฟัะฐััะตะน:\n1. ะฃะบะฐะถะธัะต ะผะพะดะตะปั ะธ ะณะพะด ะฒัะฟััะบะฐ ัะบััะตัะฐ\n2. ะัะพะฒะตัััะต ัะพะฒะผะตััะธะผะพััั ะฒ ะพะฟะธัะฐะฝะธะธ ัะพะฒะฐัะฐ\n3. ะัะปะธ ะฝัะถะฝะฐ ะฟะพะผะพัั - ะฝะฐะฟะธัะธัะต ะฝะฐะผ ะฒ WhatsApp ะธะปะธ Telegram";
  }

  if (/ะณัะฐัะธะบ|ะฒัะตะผั.*ัะฐะฑะพั|ะบะพะณะดะฐ.*ะพัะบััั|ัะฐัั.*ัะฐะฑะพั/i.test(message)) {
    return "ะะฐั ะผะฐะณะฐะทะธะฝ ัะฐะฑะพัะฐะตั:\nะะฝ-ะั: 9:00-18:00\nะกะฑ: 10:00-15:00\nะั: ะฒััะพะดะฝะพะน";
  }

  if (/ะฐะดัะตั|ะณะดะต.*ะฝะฐัะพะดะธััั|ะบะฐะบ.*ะดะพะตัะฐัั|ะผะตััะพะฟะพะปะพะถะตะฝะธะต/i.test(message)) {
    return "ะะฐั ะผะฐะณะฐะทะธะฝ ะฝะฐัะพะดะธััั ะฟะพ ะฐะดัะตัั:\nะะพััะพะฒ-ะฝะฐ-ะะพะฝั, ัะป. ะัะฐะฝะบะพ, ะด. 141\nะัะดะพะผ ั ะขะฆ 'ะะพัะธะทะพะฝั'";
  }

  if (/ะฟะฐัััะฑะบ|ะฒััะปะพะฟะฝ?|ะณะปััะธัะตะปั/i.test(message)) {
    return "ะะปั ะฟะพะดะฑะพัะฐ ะฟะฐัััะฑะบะพะฒ:\n1. ะะทะผะตัััะต ะดะธะฐะผะตัั ะฒััะปะพะฟะฝะพะน ัััะฑั\n2. ะฃะบะฐะถะธัะต ะผะพะดะตะปั ัะบััะตัะฐ\n3. ะัะฑะตัะธัะต ะผะฐัะตัะธะฐะป (ะฝะตัะถะฐะฒะตะนะบะฐ/ะบะฐัะฑะพะฝ)\n4. ะัะปะธ ัะพะผะฝะตะฒะฐะตัะตัั - ะฟัะธัะปะธัะต ัะพัะพ, ะฟะพะผะพะถะตะผ ั ะฒัะฑะพัะพะผ!";
  }

  if (/ะบะพะฝัะฐะบั|ัะฒัะทะฐัััั|ัะตะปะตัะพะฝ|whatsapp|telegram|ะฟะพััะฐ|email/i.test(message)) {
    return "ะะฐัะธ ะบะพะฝัะฐะบัั:\nะขะตะปะตัะพะฝ: +7 (863) 123-45-67\nWhatsApp: +7 (900) 123-45-67\nTelegram: @scooter_parts_shop\nEmail: info@scooter-parts.ru";
  }

  if (/ะฟัะธะฒะตั|ะทะดัะฐะฒััะฒัะน|ะฝะฐัะฐัั|ััะฐัั/i.test(message)) {
    return "ะัะธะฒะตั! ะฏ ะฒะธัััะฐะปัะฝัะน ะฟะพะผะพัะฝะธะบ ะผะฐะณะฐะทะธะฝะฐ ะทะฐะฟัะฐััะตะน ะดะปั ัะบััะตัะพะฒ. ะะฐะดะฐะนัะต ะฒะฐั ะฒะพะฟัะพั ะธะปะธ ะฒัะฑะตัะธัะต ะบะฐัะตะณะพัะธั ะธะท ะผะตะฝั ะฝะธะถะต.";
  }

  // ะะพะฝัะตะบััะฝัะต ะพัะฒะตัั
  if (/ะดะฐ|ะบะพะฝะตัะฝะพ|ะฐะณะฐ/i.test(message) && /ะฝัะถะฝะฐ ะฟะพะผะพัั/i.test(lastQuestion)) {
    return "ะัะปะธัะฝะพ! ะะฐะฟะธัะธัะต ะฒะฐั ะฒะพะฟัะพั, ะธ ั ะฟะพััะฐัะฐััั ะฟะพะผะพัั. ะะปะธ ะฒั ะผะพะถะตัะต ััะฐะทั ัะฒัะทะฐัััั ั ะฝะฐะผะธ ัะตัะตะท ะผะตััะตะฝะดะถะตัั.";
  }

  if (/ะฝะตั|ะฝะต ะฝะฐะดะพ/i.test(message) && /ะฝัะถะฝะฐ ะฟะพะผะพัั/i.test(lastQuestion)) {
    return "ะฅะพัะพัะพ! ะัะปะธ ะฟะตัะตะดัะผะฐะตัะต - ะพะฑัะฐัะฐะนัะตัั. ะัะดั ัะฐะด ะฟะพะผะพัั ั ะฒัะฑะพัะพะผ ะทะฐะฟัะฐััะตะน ะดะปั ะฒะฐัะตะณะพ ัะบััะตัะฐ!";
  }

  return "ะะทะฒะธะฝะธัะต, ั ะฝะต ะฟะพะฝัะป ะฒะพะฟัะพั. ะะพะฟัะพะฑัะนัะต ััะพัะผัะปะธัะพะฒะฐัั ะธะฝะฐัะต ะธะปะธ ะฒัะฑะตัะธัะต ะพะดะธะฝ ะธะท ะฒะฐัะธะฐะฝัะพะฒ:";
}

// ะัะธััะบะฐ ััะฐััั ะบะพะฝัะตะบััะพะฒ
setInterval(() => {
  const now = Date.now();
  for (const [key, value] of dialogContext.entries()) {
    if (now - value.lastActivity > 30 * 60 * 1000) { // 30 ะผะธะฝัั ะฝะตะฐะบัะธะฒะฝะพััะธ
      dialogContext.delete(key);
    }
  }
}, 60 * 1000);

app.listen(3001, () => {
  console.log("๐ค ะฃะผะฝัะน ะฑะพั ัะฐะฑะพัะฐะตั ะฝะฐ http://localhost:3001");
  console.log("๐ ะะพัะพะฒ ะบ ะฟัะธะตะผั ัะพะพะฑัะตะฝะธะน!");
});